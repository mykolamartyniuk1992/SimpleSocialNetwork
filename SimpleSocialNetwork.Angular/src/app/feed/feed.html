<div class="feed-container">
  <h2>Feed</h2>

  <mat-card class="create-post-card">
    <mat-card-content>
      <form [formGroup]="postForm" (ngSubmit)="createPost()">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>What's on your mind?</mat-label>
          <textarea matInput formControlName="text" placeholder="Share something..." rows="3" maxlength="500"
            [disabled]="isPostingDisabled"></textarea>
          <mat-hint align="end">{{postForm.get('text')?.value?.length || 0}}/500</mat-hint>
          @if (isPostingDisabled) {
          <mat-error>You have reached your message limit. Cannot post more messages.</mat-error>
          } @else if (postForm.get('text')?.hasError('required') && postForm.get('text')?.touched) {
          <mat-error>Please enter some text</mat-error>
          }
        </mat-form-field>
        <div class="post-actions">
          <button mat-raised-button color="primary" type="submit"
            [disabled]="postForm.invalid || posting || isPostingDisabled">
            <mat-icon>send</mat-icon>
            {{ posting ? 'Posting...' : 'Post' }}
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  @if (loading) {
  <div class="loading">
    <mat-spinner></mat-spinner>
  </div>
  } @else if (feeds.length === 0) {
  <mat-card>
    <mat-card-content>
      <p>No posts yet. Be the first to post!</p>
    </mat-card-content>
  </mat-card>
  } @else {
  @for (feed of feeds; track feed.id) {
  <mat-card class="feed-item">
    <mat-card-header>
      <div mat-card-avatar class="feed-avatar">
        @if (feed.profilePhotoPath) {
        <img [src]="getFullPhotoUrl(feed.profilePhotoPath)" alt="Profile" class="avatar-photo">
        } @else {
        <mat-icon>account_circle</mat-icon>
        }
      </div>
      <mat-card-title>{{ feed.name }}</mat-card-title>
      <mat-card-subtitle>{{ feed.date }}</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <p>{{ feed.text }}</p>
    </mat-card-content>
    <mat-card-actions>
      <div class="likes-wrapper"
     (mouseenter)="showLikesPopup(feed, $event)"
     (mouseleave)="hideLikesPopup(feed)"
     (touchstart)="onTouchStart(feed, $event)"
     (touchend)="onTouchEnd(feed, $event)"
     (touchcancel)="onTouchEnd(feed, $event)">

  <button mat-button
          (click)="toggleLike(feed)"
          [disabled]="liking[feed.id]"
          [color]="feed.isLiked ? 'primary' : ''">
    <mat-icon>{{ feed.isLiked ? 'thumb_up' : 'thumb_up_off_alt' }}</mat-icon>
    <span>{{ getLikesCount(feed) }}</span>
  </button>

  <ng-container *ngIf="feed.showLikesPopup">
        <div class="likes-popup"
          [ngStyle]="getLikesPopupStyle(feed)"
          [class.above]="feed.popupPosition === 'top'"
          [class.below]="feed.popupPosition === 'bottom'">
      <div *ngIf="feed.likesLoading" class="likes-loading">
        Loading...
      </div>

      <div *ngIf="!feed.likesLoading && feed.lastLikes && feed.lastLikes.length > 0">
        <div *ngFor="let like of feed.lastLikes" class="like-user">
          <img *ngIf="like.photoPath"
               [src]="getFullPhotoUrl(like.photoPath)"
               class="like-avatar"
               alt="avatar"
               (error)="$event.target.style.display='none'" />
          <mat-icon *ngIf="!like.photoPath">account_circle</mat-icon>
          <span>{{ like.profileName }}</span>
        </div>

        <button mat-stroked-button
                color="primary"
                class="show-all-likes-btn"
                (click)="openLikesDialog(feed, $event)">
          Show all
        </button>
      </div>

      <div *ngIf="!feed.likesLoading && (!feed.lastLikes || feed.lastLikes.length === 0)">
        No likes yet
      </div>
    </div>
  </ng-container>
</div>
      @if (getCommentsCount(feed) > 0) {
      <button mat-button (click)="toggleComments(feed)">
        <mat-icon>{{ feed.showComments ? 'expand_less' : 'expand_more' }}</mat-icon>
        <span>{{ feed.showComments ? 'Hide' : 'Show' }} Comments ({{ getCommentsCount(feed) }})</span>
      </button>
      }
      <button mat-button (click)="toggleCommentForm(feed)">
        <mat-icon>add_comment</mat-icon>
        <span>Reply</span>
      </button>
      @if (canDeleteFeed(feed)) {
      <button mat-button (click)="deleteFeed(feed)" color="warn">
        <mat-icon>delete</mat-icon>
        <span>Delete</span>
      </button>
      }
    </mat-card-actions>

    @if (feed.showCommentForm) {
    <mat-card-content class="comment-form">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Write a comment...</mat-label>
        <textarea matInput [(ngModel)]="feed.commentText" rows="2" maxlength="500"
          [disabled]="isPostingDisabled"></textarea>
        @if (isPostingDisabled) {
        <mat-error>You have reached your message limit. Cannot post more comments.</mat-error>
        }
      </mat-form-field>
      <div class="comment-actions">
        <button mat-button (click)="toggleCommentForm(feed)">Cancel</button>
        <button mat-raised-button color="primary" (click)="submitComment(feed)"
          [disabled]="!feed.commentText || feed.commentText.trim() === '' || isPostingDisabled">
          <mat-icon>send</mat-icon>
          Post Comment
        </button>
      </div>
    </mat-card-content>
    }

    @if (feed.showComments) {
    <mat-card-content class="comments-section">
      @if (feed.comments && feed.comments.length > 0) {
      @for (comment of feed.comments; track comment.id) {
      <app-feed-comment [comment]="comment"></app-feed-comment>
      }
      }
      @if (feed.commentsTotalPages && feed.commentsTotalPages > 1) {
      <div class="pagination-container comment-pagination">
        <button mat-icon-button (click)="goToFirstCommentPage(feed)"
          [disabled]="feed.commentsPage === 1 || feed.commentsLoading" matTooltip="First Page">
          <mat-icon>first_page</mat-icon>
        </button>
        <button mat-icon-button (click)="goToPreviousCommentPage(feed)"
          [disabled]="feed.commentsPage === 1 || feed.commentsLoading" matTooltip="Previous Page">
          <mat-icon>chevron_left</mat-icon>
        </button>
        @for (page of getCommentPageNumbers(feed); track page) {
        <button mat-mini-fab [color]="feed.commentsPage === page ? 'primary' : ''" (click)="goToCommentPage(feed, page)"
          class="page-number" [disabled]="feed.commentsLoading">
          {{ page }}
        </button>
        }
        <button mat-icon-button (click)="goToNextCommentPage(feed)"
          [disabled]="feed.commentsPage === feed.commentsTotalPages || feed.commentsLoading" matTooltip="Next Page">
          <mat-icon>chevron_right</mat-icon>
        </button>
        <button mat-icon-button (click)="goToLastCommentPage(feed)"
          [disabled]="feed.commentsPage === feed.commentsTotalPages || feed.commentsLoading" matTooltip="Last Page">
          <mat-icon>last_page</mat-icon>
        </button>
        <span class="page-info">Page {{ feed.commentsPage }} of {{ feed.commentsTotalPages }}</span>
      </div>
      }
    </mat-card-content>
    }
  </mat-card>
  }

  @if (totalPages > 1) {
  <div class="pagination-container">
    <button mat-icon-button (click)="goToFirstPage()" [disabled]="currentPage === 1" matTooltip="First Page">
      <mat-icon>first_page</mat-icon>
    </button>
    <button mat-icon-button (click)="goToPreviousPage()" [disabled]="currentPage === 1" matTooltip="Previous Page">
      <mat-icon>chevron_left</mat-icon>
    </button>

    @for (pageNum of getPageNumbers(); track pageNum) {
    <button mat-raised-button [color]="pageNum === currentPage ? 'primary' : ''" (click)="goToPage(pageNum)"
      class="page-number">
      {{ pageNum }}
    </button>
    }

    <button mat-icon-button (click)="goToNextPage()" [disabled]="currentPage === totalPages" matTooltip="Next Page">
      <mat-icon>chevron_right</mat-icon>
    </button>
    <button mat-icon-button (click)="goToLastPage()" [disabled]="currentPage === totalPages" matTooltip="Last Page">
      <mat-icon>last_page</mat-icon>
    </button>

    <span class="page-info">Page {{ currentPage }} of {{ totalPages }}</span>
  </div>
  }
  }
</div>