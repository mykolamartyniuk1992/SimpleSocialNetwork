<div class="admin-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <mat-icon>admin_panel_settings</mat-icon>
        Admin Panel
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="config-section">
        <h3>API Configuration</h3>
        <p class="current-url">Current API URL: <strong>{{ currentApiUrl }}</strong></p>
        
        <form [formGroup]="apiConfigForm" class="api-form">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>API Base URL</mat-label>
            <input matInput formControlName="apiUrl" placeholder="http://localhost:5000/api" />
            <mat-icon matPrefix>link</mat-icon>
            @if (apiConfigForm.get('apiUrl')?.hasError('required') && apiConfigForm.get('apiUrl')?.touched) {
              <mat-error>API URL is required</mat-error>
            }
            @if (apiConfigForm.get('apiUrl')?.hasError('pattern') && apiConfigForm.get('apiUrl')?.touched) {
              <mat-error>Invalid URL format (must start with http:// or https://)</mat-error>
            }
          </mat-form-field>

          <div class="button-group">
            <button mat-raised-button color="primary" (click)="onSaveApiUrl()" [disabled]="!apiConfigForm.valid" class="action-button">
              <mat-icon>save</mat-icon>
              Save API URL
            </button>
            <button mat-stroked-button color="accent" (click)="onResetToDefault()" class="action-button">
              <mat-icon>refresh</mat-icon>
              Reset to Default
            </button>
          </div>
        </form>
      </div>

      <div class="info-section">
        <mat-icon>info</mat-icon>
        <p>
          Configure the API base URL for your backend server. 
          Changes will be saved locally and applied after page refresh.
        </p>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <mat-icon>message</mat-icon>
        Message Limit Configuration
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="config-section">
        <h3>Default Message Limit for Unverified Users</h3>
        <p class="current-limit">Current default limit: <strong>{{ defaultMessageLimit }}</strong> messages</p>
        
        <form [formGroup]="messageLimitForm" class="message-form">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Message Limit</mat-label>
            <input matInput type="number" formControlName="messageLimit" placeholder="100" />
            <mat-icon matPrefix>format_list_numbered</mat-icon>
            @if (messageLimitForm.get('messageLimit')?.hasError('required') && messageLimitForm.get('messageLimit')?.touched) {
              <mat-error>Message limit is required</mat-error>
            }
            @if (messageLimitForm.get('messageLimit')?.hasError('min')) {
              <mat-error>Minimum value is 1</mat-error>
            }
            @if (messageLimitForm.get('messageLimit')?.hasError('max')) {
              <mat-error>Maximum value is 10,000</mat-error>
            }
          </mat-form-field>

          <button mat-raised-button color="primary" (click)="onSaveMessageLimit()" [disabled]="!messageLimitForm.valid || saving" class="action-button">
            <mat-icon>save</mat-icon>
            Save Message Limit
          </button>
        </form>
      </div>

      <div class="info-section">
        <mat-icon>info</mat-icon>
        <p>
          This sets the default message limit for new unverified users. 
          Verified users and admins have unlimited messages.
          Current users' limits are not affected by this change.
        </p>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <mat-icon>people</mat-icon>
        User Management
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      @if (loadingUsers) {
        <div class="loading">
          <mat-spinner></mat-spinner>
        </div>
      } @else {
        <div class="table-container">
          <table mat-table [dataSource]="users" class="users-table">
            <!-- Photo Column -->
            <ng-container matColumnDef="photo">
              <th mat-header-cell *matHeaderCellDef>Photo</th>
              <td mat-cell *matCellDef="let user">
                @if (user.photoPath) {
                  <img [src]="getFullPhotoUrl(user.photoPath)" alt="Profile" class="user-photo">
                } @else {
                  <mat-icon class="user-icon">account_circle</mat-icon>
                }
              </td>
            </ng-container>

            <!-- Email Column -->
            <ng-container matColumnDef="email">
              <th mat-header-cell *matHeaderCellDef>Email</th>
              <td mat-cell *matCellDef="let user">{{ user.email }}</td>
            </ng-container>

            <!-- Name Column -->
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Name</th>
              <td mat-cell *matCellDef="let user">{{ user.name }}</td>
            </ng-container>

            <!-- System User Column -->
            <ng-container matColumnDef="isSystemUser">
              <th mat-header-cell *matHeaderCellDef>System</th>
              <td mat-cell *matCellDef="let user">
                @if (user.isSystemUser) {
                  <mat-icon color="primary">check_circle</mat-icon>
                } @else {
                  <mat-icon>cancel</mat-icon>
                }
              </td>
            </ng-container>

            <!-- Admin Column -->
            <ng-container matColumnDef="isAdmin">
              <th mat-header-cell *matHeaderCellDef>Admin</th>
              <td mat-cell *matCellDef="let user">
                @if (user.isAdmin) {
                  <mat-icon color="primary">check_circle</mat-icon>
                } @else {
                  <mat-icon>cancel</mat-icon>
                }
              </td>
            </ng-container>

            <!-- Verified Column -->
            <ng-container matColumnDef="verified">
              <th mat-header-cell *matHeaderCellDef>Verified</th>
              <td mat-cell *matCellDef="let user">
                @if (user.verified) {
                  <mat-icon color="accent">verified</mat-icon>
                } @else {
                  <mat-icon>cancel</mat-icon>
                }
              </td>
            </ng-container>

            <!-- Messages Left Column -->
            <ng-container matColumnDef="messagesLeft">
              <th mat-header-cell *matHeaderCellDef>Messages Left</th>
              <td mat-cell *matCellDef="let user">
                @if (user.verified || user.isAdmin) {
                  <span class="unlimited-badge">Unlimited</span>
                } @else {
                  <div class="message-limit-edit">
                    <mat-form-field appearance="outline" class="message-limit-input">
                      <input matInput type="number" [(ngModel)]="user.messagesLeft" min="0" [disabled]="editingMessageLimit[user.id]" (input)="preventNegative($event)">
                    </mat-form-field>
                    <button mat-icon-button color="primary" (click)="updateUserMessageLimit(user, user.messagesLeft!)" [disabled]="editingMessageLimit[user.id] || (user.messagesLeft !== null && user.messagesLeft < 0)" matTooltip="Update message limit">
                      <mat-icon>save</mat-icon>
                    </button>
                  </div>
                }
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let user">
                <div class="action-buttons">
                  @if (user.isAdmin) {
                    <span class="admin-badge">Admin</span>
                  } @else {
                    @if (!user.verified) {
                      <button mat-raised-button color="accent" (click)="verifyUser(user)" [disabled]="verifyingUsers[user.id]">
                        <mat-icon>verified_user</mat-icon>
                        Verify
                      </button>
                    } @else {
                      <button mat-stroked-button (click)="unverifyUser(user)" [disabled]="verifyingUsers[user.id]">
                        <mat-icon>remove_moderator</mat-icon>
                        Unverify
                      </button>
                    }
                    <button mat-icon-button color="warn" (click)="deleteUser(user)" [disabled]="deletingUsers[user.id]" matTooltip="Delete user and all their content">
                      <mat-icon>delete</mat-icon>
                    </button>
                  }
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </div>
      }
    </mat-card-content>
  </mat-card>
</div>
